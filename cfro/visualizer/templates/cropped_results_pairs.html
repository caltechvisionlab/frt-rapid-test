<html>
<title>CS81 Results Tool</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Roboto'>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
    html,
    body,
    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
        font-family: "Roboto", sans-serif
    }

    .grid-container {
        display: grid;
    }
</style>

<body>
    <h1>{{"Same-ID" if same_id else "Different-ID"}} Comparison - {{confusing_or_representative.capitalize()}} Face Pairs</h1>
    <h2>Pairs of {{"same-identity" if same_id else "different-identity"}} faces with the {{"lowest" if (same_id and confusing_or_representative == "confusing") or (not same_id and confusing_or_representative == "distinguishable") else "highest"}}  match confidences.</h2>
    <form>
        <input hidden id="num_pairs" value={{num_pairs}}></input>
        {% for (idx, (confidence, name1, name2, face1_id, face2_id, image1_url, image2_url, bbox1, bbox2)) in name_url_bbox_pairs %}
        <input hidden id="text{{idx}}" value="{{name1 + ' ' if multiple_ids else ''}}#{{face1_id}} + {{name2 + ' ' if multiple_ids and name2 != name1 else ''}}#{{face2_id}} â†’ {{confidence}}"></input>

        <input hidden id="url1{{idx}}" value={{image1_url}}></input>
        <input hidden id="bbox1_l{{idx}}" value="{{bbox1[0]}}"></input>
        <input hidden id="bbox1_t{{idx}}" value="{{bbox1[1]}}"></input>
        <input hidden id="bbox1_w{{idx}}" value="{{bbox1[2]}}"></input>
        <input hidden id="bbox1_h{{idx}}" value="{{bbox1[3]}}"></input>

        <input hidden id="url2{{idx}}" value={{image2_url}}></input>
        <input hidden id="bbox2_l{{idx}}" value="{{bbox2[0]}}"></input>
        <input hidden id="bbox2_t{{idx}}" value="{{bbox2[1]}}"></input>
        <input hidden id="bbox2_w{{idx}}" value="{{bbox2[2]}}"></input>
        <input hidden id="bbox2_h{{idx}}" value="{{bbox2[3]}}"></input>

        <canvas id="canvas{{idx}}"></canvas>
        {% endfor %}
    </form>

</body>

<script>
    num_pairs = document.getElementById('num_pairs').value;
    for (i = 0; i < num_pairs; i++) {
        bbox1_l = document.getElementById('bbox1_l' + i).value;
        bbox1_t = document.getElementById('bbox1_t' + i).value;
        bbox1_w = document.getElementById('bbox1_w' + i).value;
        bbox1_h = document.getElementById('bbox1_h' + i).value;
        bbox1 = [bbox1_l, bbox1_t, bbox1_w, bbox1_h]
        url1 = document.getElementById('url1' + i).value;

        bbox2_l = document.getElementById('bbox2_l' + i).value;
        bbox2_t = document.getElementById('bbox2_t' + i).value;
        bbox2_w = document.getElementById('bbox2_w' + i).value;
        bbox2_h = document.getElementById('bbox2_h' + i).value;
        bbox2 = [bbox2_l, bbox2_t, bbox2_w, bbox2_h]
        url2 = document.getElementById('url2' + i).value;

        text = document.getElementById('text' + i).value;
        load_canvas(i, bbox1, url1, bbox2, url2, text);
    }

    function load_canvas(i, bbox1, url1, bbox2, url2, text) {

        // https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/drawImage
        const canvas = document.getElementById('canvas' + i);
        const ctx = canvas.getContext('2d');

        canvas.width = 500 * 2;
        canvas.height = 500 + 50;

        const image1 = new Image(500, 500); // Using optional size for image
        image1.onload = drawLeftImageActualSize; // Draw when image has loaded

        const image2 = new Image(500, 500); // Using optional size for image
        image2.onload = drawRightImageActualSize; // Draw when image has loaded

        // Load an image of intrinsic size 1087x782 in CSS pixels
        image1.src = url1;
        image2.src = url2;

        function drawLeftImageActualSize() {
            drawImageActualSize(this, 0, bbox1, true)
        }

        function drawRightImageActualSize() {
            drawImageActualSize(this, this.width, bbox2, false)
        }

        function drawImageActualSize(img, x_offset, bbox, left) {
            // To use the custom size we'll have to specify the scale parameters
            // using the element's width and height properties - lets draw one
            // on top in the corner:
            bbox_left = parseFloat(bbox[0]);
            bbox_top = parseFloat(bbox[1]);
            bbox_width = parseFloat(bbox[2]);
            bbox_height = parseFloat(bbox[3]);

            // Find the center of the bbox
            bbox_x_center = bbox_left + (bbox_width / 2)
            bbox_y_center = bbox_top + (bbox_height / 2)
            
            // Find the larger dimension and add some pixel padding
            larger_bbox_dim = Math.max(bbox_width, bbox_height)
            padded_bbox_dim = larger_bbox_dim * 1.5

            // Bound it to be contained within the image...
            if (bbox_x_center + padded_bbox_dim / 2 > img.naturalWidth) {
                padded_bbox_dim = 2 * (img.naturalWidth - bbox_x_center)
            }
            if (bbox_x_center - padded_bbox_dim / 2 < 0) {
                padded_bbox_dim = 2 * bbox_x_center
            }
            if (bbox_y_center + padded_bbox_dim / 2 > img.naturalHeight) {
                padded_bbox_dim = 2 * (img.naturalHeight - bbox_y_center)
            }
            if (bbox_y_center - padded_bbox_dim / 2 < 0) {
                padded_bbox_dim = 2 * bbox_y_center
            }

            cropped_left = bbox_x_center - padded_bbox_dim / 2
            cropped_top = bbox_y_center - padded_bbox_dim / 2
            cropped_width = padded_bbox_dim
            cropped_height = padded_bbox_dim

            console.assert(cropped_left >= 0)
            console.assert(cropped_top >= 0)
            console.assert(cropped_left + cropped_width <= img.naturalWidth)
            console.assert(cropped_top + cropped_height <= img.naturalHeight)

            ctx.drawImage(img, cropped_left, cropped_top, cropped_width, cropped_height, x_offset, 0, img.width, img.height);

            if (left) {
                ctx.font = "30px Arial";
                ctx.fillText(text, 10, img.height + 30);
            }
        }
    }
</script>

</html>
<html>
<title>CS81 Results Tool</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Roboto'>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
    html,
    body,
    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
        font-family: "Roboto", sans-serif
    }

    .grid-container {
        display: grid;
    }
</style>

<body>
    <h1>{{"Same-ID" if same_id else "Different-ID"}} Comparison Confusing Face Pairs</h1>
    <form>
        <input hidden id="num_pairs" value={{num_pairs}}></input>
        {% for (idx, (confidence, name1, name2, face1_id, face2_id, image1_url, image2_url, bbox1, bbox2)) in name_url_bbox_pairs %}
        <input hidden id="text{{idx}}" value="{{name1}} #{{face1_id}} and {{name2}} #{{face2_id}} had {{confidence}}."></input>

        <input hidden id="url1{{idx}}" value={{image1_url}}></input>
        <input hidden id="bbox1_l{{idx}}" value="{{bbox1[0]}}"></input>
        <input hidden id="bbox1_t{{idx}}" value="{{bbox1[1]}}"></input>
        <input hidden id="bbox1_w{{idx}}" value="{{bbox1[2]}}"></input>
        <input hidden id="bbox1_h{{idx}}" value="{{bbox1[3]}}"></input>

        <input hidden id="url2{{idx}}" value={{image2_url}}></input>
        <input hidden id="bbox2_l{{idx}}" value="{{bbox2[0]}}"></input>
        <input hidden id="bbox2_t{{idx}}" value="{{bbox2[1]}}"></input>
        <input hidden id="bbox2_w{{idx}}" value="{{bbox2[2]}}"></input>
        <input hidden id="bbox2_h{{idx}}" value="{{bbox2[3]}}"></input>

        <canvas id="canvas{{idx}}"></canvas>
        {% endfor %}
    </form>

</body>

<script>
    num_pairs = document.getElementById('num_pairs').value;
    for (i = 0; i < num_pairs; i++) {
        bbox1_l = document.getElementById('bbox1_l' + i).value;
        bbox1_t = document.getElementById('bbox1_t' + i).value;
        bbox1_w = document.getElementById('bbox1_w' + i).value;
        bbox1_h = document.getElementById('bbox1_h' + i).value;
        bbox1 = [bbox1_l, bbox1_t, bbox1_w, bbox1_h]
        url1 = document.getElementById('url1' + i).value;

        bbox2_l = document.getElementById('bbox2_l' + i).value;
        bbox2_t = document.getElementById('bbox2_t' + i).value;
        bbox2_w = document.getElementById('bbox2_w' + i).value;
        bbox2_h = document.getElementById('bbox2_h' + i).value;
        bbox2 = [bbox2_l, bbox2_t, bbox2_w, bbox2_h]
        url2 = document.getElementById('url2' + i).value;

        text = document.getElementById('text' + i).value;
        load_canvas(i, bbox1, url1, bbox2, url2, text);
    }

    function load_canvas(i, bbox1, url1, bbox2, url2, text) {

        // https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/drawImage
        const canvas = document.getElementById('canvas' + i);
        const ctx = canvas.getContext('2d');

        canvas.width = 500 * 2;
        canvas.height = 350 + 50;

        const image1 = new Image(500, 350); // Using optional size for image
        image1.onload = drawLeftImageActualSize; // Draw when image has loaded

        const image2 = new Image(500, 350); // Using optional size for image
        image2.onload = drawRightImageActualSize; // Draw when image has loaded

        // Load an image of intrinsic size 1087x782 in CSS pixels
        image1.src = url1;
        image2.src = url2;

        function drawLeftImageActualSize() {
            drawImageActualSize(this, 0, bbox1, true)
        }

        function drawRightImageActualSize() {
            drawImageActualSize(this, this.width, bbox2, false)
        }

        function drawImageActualSize(img, x_offset, bbox, left) {
            ctx.drawImage(img, x_offset, 0, img.width, img.height)

            bbox_left = bbox[0];
            bbox_top = bbox[1];
            bbox_width = bbox[2];
            bbox_height = bbox[3];

            bbox_left /= img.naturalWidth;
            bbox_top /= img.naturalHeight;
            bbox_width /= img.naturalWidth;
            bbox_height /= img.naturalHeight;

            bbox_left *= img.width;
            bbox_top *= img.height;
            bbox_width *= img.width;
            bbox_height *= img.height;

            if (!left) {
                bbox_left += 500;
            }

            // https://www.w3schools.com/tags/canvas_rect.asp
            // context.rect(x,y,width,height);
            // x,y are for upper left corner
            ctx.beginPath();
            ctx.lineWidth = "6";
            ctx.strokeStyle = "red";
            ctx.rect(bbox_left, bbox_top, bbox_width, bbox_height);
            ctx.stroke();

            if (left) {
                ctx.font = "20px Arial";
                ctx.fillText(text, 10, img.height + 25);
            }
        }
    }
</script>

</html>
<html>
<title>CS81 Results Tool</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Roboto'>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
    html,
    body,
    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
        font-family: "Roboto", sans-serif
    }

    /* This can be removed? */
    .grid-container {
        display: grid;
    }
</style>

<body>
    <h1>{{"Same-ID" if same_id else "Different-ID"}} Comparison - {{confusing_or_representative.capitalize()}} Faces</h1>
    <h2>Faces with the {{"lowest" if (same_id and confusing_or_representative == "confusing") or (not same_id and confusing_or_representative == "distinguishable") else "highest"}} {{"average" if avg_or_median == "avg" else "median"}} match confidences when compared to {{"same-identity" if same_id else "different-identity"}} faces.</h2>
    <form>
        <input hidden id="num_faces" value={{num_faces}}></input>
        {% for (idx, (avg_confidence, name, face_id, image_url, bbox, count)) in conf_id_url_bbox %}
        <!-- TODO - At some point, add back in the number of comparisons using \{\{count\}\}??? -->
        <input hidden id="text{{idx}}"
            value="{{name + ' ' if multiple_ids else ''}}#{{face_id}} â†’ {{avg_confidence}}"></input>
        <input hidden id="url{{idx}}" value={{image_url}}></input>
        <input hidden id="bbox_l{{idx}}" value="{{bbox[0]}}"></input>
        <input hidden id="bbox_t{{idx}}" value="{{bbox[1]}}"></input>
        <input hidden id="bbox_w{{idx}}" value="{{bbox[2]}}"></input>
        <input hidden id="bbox_h{{idx}}" value="{{bbox[3]}}"></input>
        <canvas id="canvas{{idx}}"></canvas>
        {% endfor %}
    </form>

</body>

<script>
    num_faces = document.getElementById('num_faces').value;
    for (i = 0; i < num_faces; i++) {
        bbox_l = document.getElementById('bbox_l' + i).value;
        bbox_t = document.getElementById('bbox_t' + i).value;
        bbox_w = document.getElementById('bbox_w' + i).value;
        bbox_h = document.getElementById('bbox_h' + i).value;
        bbox = [bbox_l, bbox_t, bbox_w, bbox_h]
        url = document.getElementById('url' + i).value;
        text = document.getElementById('text' + i).value;
        load_canvas(i, bbox, url, text);
    }

    function load_canvas(i, bbox, url, text) {

        // https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/drawImage
        const canvas = document.getElementById('canvas' + i);
        const ctx = canvas.getContext('2d');

        const image = new Image(500, 500); // Using optional size for image
        image.onload = drawImageActualSize; // Draw when image has loaded

        // Load an image of intrinsic size 1087x782 in CSS pixels
        image.src = url;

        function drawImageActualSize() {
            canvas.width = this.width;
            canvas.height = this.height + 50;

            bbox_left = parseFloat(bbox[0]);
            bbox_top = parseFloat(bbox[1]);
            bbox_width = parseFloat(bbox[2]);
            bbox_height = parseFloat(bbox[3]);

            // Find the center of the bbox
            bbox_x_center = bbox_left + (bbox_width / 2)
            bbox_y_center = bbox_top + (bbox_height / 2)

            // Find the larger dimension and add some pixel padding
            larger_bbox_dim = Math.max(bbox_width, bbox_height)
            padded_bbox_dim = larger_bbox_dim * 1.5

            // Bound it to be contained within the image...
            if (bbox_x_center + padded_bbox_dim / 2 > this.naturalWidth) {
                padded_bbox_dim = 2 * (this.naturalWidth - bbox_x_center)
            }
            if (bbox_x_center - padded_bbox_dim / 2 < 0) {
                padded_bbox_dim = 2 * bbox_x_center
            }
            if (bbox_y_center + padded_bbox_dim / 2 > this.naturalHeight) {
                padded_bbox_dim = 2 * (this.naturalHeight - bbox_y_center)
            }
            if (bbox_y_center - padded_bbox_dim / 2 < 0) {
                padded_bbox_dim = 2 * bbox_y_center
            }

            cropped_left = bbox_x_center - padded_bbox_dim / 2
            cropped_top = bbox_y_center - padded_bbox_dim / 2
            cropped_width = padded_bbox_dim
            cropped_height = padded_bbox_dim

            console.assert(cropped_left >= 0)
            console.assert(cropped_top >= 0)
            console.assert(cropped_left + cropped_width <= this.naturalWidth)
            console.assert(cropped_top + cropped_height <= this.naturalHeight)

            ctx.drawImage(this, cropped_left, cropped_top, cropped_width, cropped_height, 0, 0, this.width, this.height);

            ctx.font = "30px Arial";
            ctx.fillText(text, 10, this.height + 30);
        }
    }
</script>

</html>